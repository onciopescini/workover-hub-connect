
# HOTFIX: Resolve Ambiguous Foreign Key (PGRST201)

## Root Cause Analysis

The database has **two foreign key constraints** from `payments.booking_id` to `bookings.id`:

| Constraint Name | ON DELETE Behavior | Origin |
|-----------------|-------------------|--------|
| `payments_booking_id_fkey` | CASCADE | Original (Supabase auto-generated) |
| `fk_payments_booking_id` | SET NULL | Added in migration `20260127132849_*.sql` |

This duplication causes:
1. **PGRST201 Error**: PostgREST cannot determine which relationship to use for embedding
2. **Conflicting behavior**: One cascades deletes, one sets null

---

## Solution: Two-Part Fix

### Part 1: Database Migration (Drop Duplicate Constraint)

Create `supabase/migrations/YYYYMMDDHHMMSS_fix_duplicate_payments_fk.sql`:

```sql
-- Fix PGRST201: Drop duplicate foreign key constraint
-- The payments table has two FK constraints to bookings:
-- 1. payments_booking_id_fkey (original, ON DELETE CASCADE)
-- 2. fk_payments_booking_id (duplicate, ON DELETE SET NULL)
-- 
-- We keep the original CASCADE behavior as it's the correct semantic
-- for a payment-booking relationship.

ALTER TABLE public.payments
DROP CONSTRAINT IF EXISTS fk_payments_booking_id;

COMMENT ON CONSTRAINT payments_booking_id_fkey ON public.payments IS 
'Foreign key to bookings. ON DELETE CASCADE ensures payments are removed when booking is deleted.';
```

### Part 2: Frontend Queries (Add Explicit FK Hints)

Even after fixing the database, we should add explicit FK hints as a defensive measure to prevent future ambiguity issues.

**File: `src/hooks/queries/bookings/useBookingDataFetcher.ts`**

Lines 31-36 and 125-130 - Change:
```typescript
// BEFORE
payments (
  id,
  payment_status,
  amount,
  created_at
)

// AFTER
payments!payments_booking_id_fkey (
  id,
  payment_status,
  amount,
  created_at
)
```

**File: `src/lib/host-utils.ts`**

Lines 80-85 - Change:
```typescript
// BEFORE
payments (
  id,
  payment_status,
  amount,
  created_at
)

// AFTER
payments!payments_booking_id_fkey (
  id,
  payment_status,
  amount,
  created_at
)
```

**File: `src/services/api/paymentService.ts`**

Lines 112-119 and 173-175 - Change:
```typescript
// BEFORE
bookings!inner (
  id,
  booking_date,
  space_id,
  spaces!inner (
    host_id
  )
)

// AFTER - No change needed here since this is from payments TO bookings
// The FK hint goes on the child relation, not the parent
// Keep as-is
```

---

## Files to Modify

| File | Change |
|------|--------|
| `supabase/migrations/YYYYMMDDHHMMSS_fix_duplicate_payments_fk.sql` | Drop duplicate FK constraint |
| `src/hooks/queries/bookings/useBookingDataFetcher.ts` | Add `!payments_booking_id_fkey` hint (2 places) |
| `src/lib/host-utils.ts` | Add `!payments_booking_id_fkey` hint (1 place) |

---

## Technical Details

### Why Drop vs Keep?

We drop `fk_payments_booking_id` (SET NULL) and keep `payments_booking_id_fkey` (CASCADE) because:
- **CASCADE** is semantically correct: If a booking is deleted, its payments should be deleted too (orphan payments make no sense)
- The original constraint was auto-generated by Supabase when the table was created
- SET NULL would leave orphaned payment records with no booking reference

### PostgREST FK Hint Syntax

When using embedded resources in Supabase queries:
```
table_name!constraint_name(columns)
```

This tells PostgREST exactly which relationship path to use, eliminating ambiguity.

---

## Verification

After implementation:
- [ ] `fetchCoworkerBookings` returns bookings with payments without PGRST201 error
- [ ] `fetchHostBookings` returns bookings with payments without PGRST201 error
- [ ] Host dashboard loads correctly
- [ ] Booking details page shows payment information
